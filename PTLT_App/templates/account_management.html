{% extends "admin_navbar.html" %}
{% load static %}

{% block help_images_script %}
<script id="help-data" type="application/json">
{
    "steps": [
        "{% static 'image/Admin-AccManage-1.PNG' %}",
        "{% static 'image/Admin-AccManage-2.PNG' %}",
        "{% static 'image/Admin-AccManage-3.PNG' %}"
    ]
}
</script>
{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Management</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    {% load static %}
    <link rel="stylesheet" href="{% static 'css/account_management.css' %}">
    
    <style>
        /* Responsive improvements */
        @media (max-width: 768px) {
            .container {
                padding-left: 10px !important;
                padding-right: 10px !important;
            }
            
            .custom-min-width {
                min-width: auto !important;
            }
            
            /* Header adjustments */
            .page-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 15px;
            }
            
            .search-container {
                width: 100% !important;
                align-items: flex-start !important;
            }
            
            #search-input {
                width: 100% !important;
                max-width: 100% !important;
            }
            
            /* Alert adjustments */
            .alert {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 10px;
                font-size: 0.9rem;
            }
            
            .alert > div {
                width: 100%;
            }
            
            /* Table responsive */
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .table th, .table td {
                padding: 0.5rem 0.25rem;
                white-space: nowrap;
                font-size: 0.75rem;
            }
            
            .btn-sm {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }
            
            /* Action buttons stack */
            .action-buttons {
                display: flex;
                flex-direction: column;
                gap: 3px;
            }
            
            .action-buttons .btn {
                width: 100%;
                margin: 0 !important;
            }
            
            h3 {
                font-size: 1.25rem;
            }
            
            /* Filter adjustments */
            .filter-section {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .table th, .table td {
                font-size: 0.7rem;
                padding: 0.4rem 0.2rem;
            }
            
            .badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
            
            h3 {
                font-size: 1.1rem;
            }
            
            /* Pagination adjustments */
            .pagination-info {
                font-size: 0.8rem;
            }
        }
        
        /* Better button spacing */
        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }
    </style>
</head>
<body>

<div class="container py-4 custom-min-width px-md-3 px-2">
    <div class="container py-3 bg-white shadow rounded-4 p-md-4 p-3">

        <!-- Header with Search -->
        <div class="page-header d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0 text-decoration-underline">Account Management</h3>
            
            <div class="search-container d-flex flex-column align-items-end">
                <label for="search-input" class="form-label mb-1 fw-semibold">Search User</label>
                <input type="text" id="search-input" class="form-control form-control-sm border-secondary"
                    placeholder="Type First Name or Last Name"
                    style="width: 210px; box-shadow: 0 0 4px rgba(0, 0, 0, 0.3); font-style: italic;"
                    oninput="this.value = this.value.replace(/[^a-zA-Z\s]/g, '')">
            </div>
        </div>

        <!-- Sync Reminder Alert -->
        {% if update_count > 0 %}
        <div class="alert alert-warning alert-dismissible fade show d-flex justify-content-between align-items-center mb-3" role="alert">
            <div>
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>Sync Required:</strong> {{ update_count }} account{{ update_count|pluralize }} updated. Please sync to mobile app.
            </div>
            <div>
                <a href="?mark_updates_read=true" class="btn btn-sm btn-outline-dark">Dismiss</a>
            </div>
        </div>
        {% endif %}

        <!-- Filter Section -->
        <h3 class="mb-3">Filter Accounts:</h3>
        <div class="row g-3 mb-4 filter-section">
            <div class="col-md-4 col-12">
                <label for="role" class="form-label">Role:</label>
                <select id="role" class="form-select">
                    <option value="">Show All</option>
                    <option value="Instructor" {% if role_filter == 'Instructor' %}selected{% endif %}>Instructor</option>
                    <option value="Student" {% if role_filter == 'Student' %}selected{% endif %}>Student</option>
                    <option value="Admin" {% if role_filter == 'Admin' %}selected{% endif %}>Admin</option>
                </select>
            </div>
            <div class="col-md-4 col-12">
                <label for="status" class="form-label">Status:</label>
                <select id="status" class="form-select">
                    <option value="">Show All</option>
                    <option value="Active" {% if status_filter == 'Active' %}selected{% endif %}>Active</option>
                    <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
                    <option value="Inactive" {% if status_filter == 'Inactive' %}selected{% endif %}>Inactive</option>
                </select>
            </div>
            <div class="col-md-4 col-12">
                <label for="course" class="form-label">Course/Year/Section:</label>
                <select id="course" class="form-select">
                    <option value="">Show All</option>
                    {% for course in course_sections %}
                        <option value="{{ course.course_section }}" {% if course_filter == course.course_section %}selected{% endif %}>{{ course.course_section }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Account Table -->
        <h3 class="mb-4">Account List</h3>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>User ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Role</th>
                        <th>Email</th>
                        <th>Course/Section</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for account in accounts %}
                    <tr data-id="{{ account.id }}">
                        <td class="editable user_id">{{ account.user_id }}</td>
                        <td class="editable first_name">{{ account.first_name }}</td>
                        <td class="editable last_name">{{ account.last_name }}</td>
                        <td class="editable role">{{ account.role }}</td>
                        <td class="editable email">{{ account.email }}</td>
                        <td class="editable course_section">
                            {% if account.course_section %}
                                {{ account.course_section.course_section }}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td><span class="badge bg-success">Active</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-outline-primary edit-btn"
                                        data-id="{{ account.user_id }}"
                                        {% if account.user_id == '000000' %} disabled {% endif %}>
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn"
                                        data-id="{{ account.user_id }}"
                                        {% if account.user_id == '000000' %} disabled {% endif %}>
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center">No accounts found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Improved Pagination -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mt-3 gap-2">
            <span class="pagination-info text-muted">
                {% if accounts.paginator.count > 0 %}
                    Showing {{ accounts.start_index }}-{{ accounts.end_index }} of {{ accounts.paginator.count }} result{{ accounts.paginator.count|pluralize }}
                {% else %}
                    No results found
                {% endif %}
            </span>
            <nav aria-label="Account pagination">
                <ul class="pagination pagination-sm mb-0">
                    {% if accounts.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page=1" aria-label="First">
                                <span aria-hidden="true">&laquo;&laquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ accounts.previous_page_number }}" aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;&laquo;</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&laquo;</span>
                        </li>
                    {% endif %}

                    {% for num in accounts.paginator.page_range %}
                        {% if accounts.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > accounts.number|add:'-3' and num < accounts.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if accounts.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ accounts.next_page_number }}" aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ accounts.paginator.num_pages }}" aria-label="Last">
                                <span aria-hidden="true">&raquo;&raquo;</span>
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&raquo;&raquo;</span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>

    </div>
</div>

<form style="display:none;">{% csrf_token %}</form>
<script src="{% static 'js/account_management_actions.js' %}"></script>

<!-- Help Guide Modal -->
<div class="modal fade" id="helpGuideModal" tabindex="-1" aria-labelledby="helpGuideLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content shadow">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="helpGuideLabel">
                    <i class="bi bi-question-circle me-2"></i>Help Guide
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex justify-content-center" id="helpSlide">
                <img id="helpImage" src="" alt="Help Guide Step" class="img-fluid rounded shadow" style="max-height: 75vh;" />
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <button id="prevHelp" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Previous
                </button>
                <button id="nextHelp" class="btn btn-primary">
                    Next <i class="bi bi-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Course filter functionality
document.getElementById('course').addEventListener('change', function() {
    const role = document.getElementById('role').value;
    const status = document.getElementById('status').value;
    const course = this.value;
    const search = document.getElementById('search-input').value;
    
    const params = new URLSearchParams(window.location.search);
    
    // Update or remove parameters
    if (role) params.set('role', role);
    else params.delete('role');
    
    if (status) params.set('status', status);
    else params.delete('status');
    
    if (course) params.set('course', course);
    else params.delete('course');
    
    if (search) params.set('search', search);
    else params.delete('search');
    
    // Remove page parameter to reset to first page
    params.delete('page');
    
    // Redirect with new parameters
    window.location.href = '?' + params.toString();
});
</script>
</body>

{% endblock %}