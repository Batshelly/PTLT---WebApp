{% extends "inst_navbar.html" %}
{% load static %}
{% load schedule_tags %}

{% block content %}
<!-- Custom CSS for this page only -->
<link rel="stylesheet" href="{% static 'css/schedule.css' %}">

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />

<style>
    /* CRITICAL: Prevent any horizontal overflow */
    * {
        box-sizing: border-box;
    }
    
    body, html {
        overflow-x: hidden !important;
        width: 100%;
        max-width: 100vw;
    }
    
    /* Prevent containers from overflowing */
    .container, .container-fluid {
        max-width: 100% !important;
        overflow-x: hidden;
        padding-left: 15px;
        padding-right: 15px;
    }
    
    /* Force FullCalendar to respect container width */
    #schedule-overview {
        max-width: 100%;
        overflow: hidden;
    }
    
    #calendar {
        max-width: 100%;
        overflow: hidden;
    }
    
    .fc {
        max-width: 100% !important;
        overflow: hidden;
    }
    
    .fc-view-harness {
        overflow-x: auto !important;
        overflow-y: hidden;
    }
    
    /* Make table scrollable horizontally */
    .table-responsive {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
        display: block;
        width: 100%;
        max-width: 100%;
    }
    
    /* Mobile specific styles */
    @media (max-width: 768px) {
        body {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .container-fluid {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }
        
        #schedule-overview,
        #schedule-overview > div {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }
        
        .table {
            min-width: 700px;
            font-size: 0.8rem;
        }
        
        .table th,
        .table td {
            padding: 0.4rem;
            white-space: nowrap;
        }
        
        .btn-sm {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* FullCalendar mobile adjustments */
        .fc-toolbar {
            flex-direction: column !important;
            gap: 10px;
        }
        
        .fc-toolbar-chunk {
            display: flex;
            justify-content: center;
        }
        
        .fc-button {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        
        .fc-toolbar-title {
            font-size: 1rem !important;
        }
        
        .fc-daygrid-day-number {
            font-size: 0.8rem;
        }
        
        .fc-col-header-cell-cushion {
            font-size: 0.75rem;
        }
    }
</style>

<div class="container-fluid px-3 py-4">

    <div id="schedule-overview" class="bg-white shadow rounded-4 p-3 p-md-4 mb-4">
        <h2 class="mb-4 text-decoration-underline">Schedule Overview</h2>
        <div id='calendar'></div>
    </div>

    <!-- FullCalendar Scripts -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth',
            allDaySlot: false,
            slotMinTime: "07:00:00",
            slotMaxTime: "18:00:00",
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: window.innerWidth < 768 ? 'listWeek,dayGridMonth' : 'dayGridMonth,timeGridWeek,listWeek'
            },
            height: 'auto',

            eventDidMount: function(info) {
                const { courseCode, courseTitle, room, timeIn, timeOut } = info.event.extendedProps;

                const customHTML = `
                    <div style="white-space: normal; line-height: 1.2; font-size: 0.85rem;">
                        ${courseCode} - ${courseTitle}<br>
                        (${room} â€“ ${timeIn} to ${timeOut})
                    </div>
                `;

                const titleEl = info.el.querySelector('.fc-event-title');
                if (titleEl) {
                    titleEl.innerHTML = customHTML;
                }
            },

            events: [
                {% for sched in class_schedules %}
                {
                    title: "",  // We override this in eventDidMount
                    extendedProps: {
                        courseCode: "{{ sched.course_code }}",
                        courseTitle: "{{ sched.course_title }}",
                        section: "{{ sched.course_section }}",
                        room: "{{ sched.room_assignment }}",
                        timeIn: "{{ sched.time_in|time:'H:i' }}",
                        timeOut: "{{ sched.time_out|time:'H:i' }}"
                    },
                    daysOfWeek: [
                        {% for day in sched.day_list %}
                            {% if day|lower == 'monday' %}1{% elif day|lower == 'tuesday' %}2
                            {% elif day|lower == 'wednesday' %}3{% elif day|lower == 'thursday' %}4
                            {% elif day|lower == 'friday' %}5{% elif day|lower == 'saturday' %}6
                            {% elif day|lower == 'sunday' %}0{% endif %}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    startTime: "{{ sched.time_in|time:'H:i:s' }}",
                    endTime: "{{ sched.time_out|time:'H:i:s' }}",
                    startRecur: new Date().getFullYear() + "-01-01",
                    endRecur: new Date().getFullYear() + "-12-31",
                },
                {% endfor %}
            ]
        });

        calendar.render();
        
        // Handle window resize
        window.addEventListener('resize', function() {
            calendar.changeView(window.innerWidth < 768 ? 'listWeek' : 'dayGridMonth');
        });
    });
    </script>

    <div class="bg-white shadow rounded-4 p-3 p-md-4">
        <h3 class="mb-4 text-decoration-underline">Current Courses</h3>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Time in</th>
                        <th>Time Out</th>
                        <th>Room</th>
                        <th>Students</th>
                        <th>Grace Period (min)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sched in class_schedules %}
                    <tr>
                        <td>{{ sched.course_code }}</td>
                        <td>{{ sched.course_title }}</td>
                        <td class="timein">{{ sched.time_in|time:"H:i" }}</td>
                        <td class="timeout">{{ sched.time_out|time:"H:i" }}</td>
                        <td class="room">{{ sched.room_assignment }}</td>
                        <td>{{ sched.student_count }}</td>
                        <td class="grace">{{ sched.grace_period }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary toggle-course-edit-btn"
                                    data-sched-id="{{ sched.id }}">
                                Edit
                            </button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">No courses found for this instructor.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>    
        </div>
    </div>
</div>

<!-- JSON block to pass image URLs to JS -->
<script id="help-data" type="application/json">
{
    "steps": [
        "{% static 'image/schedule_inst.png' %}",
        "{% static 'image/attendance_records_inst.png' %}"
    ]
}
</script>

<!-- Modal -->
<div class="modal fade" id="helpGuideModal" tabindex="-1" aria-labelledby="helpGuideLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="helpGuideLabel">Help Guide</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex justify-content-center" id="helpSlide">
        <img id="helpImage" src="" alt="Help Guide Step" class="img-fluid rounded shadow" style="max-height: 75vh;" />
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button id="prevHelp" class="btn btn-secondary">Previous</button>
        <button id="nextHelp" class="btn btn-primary">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="{% static 'js/instructor_schedule.js' %}"></script>

{% endblock %}