{% extends "inst_navbar.html" %}
{% load static %}
{% load schedule_tags %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/schedule.css' %}">
</head>
<body style="background: linear-gradient(135deg, #e61717, #ea4444, #ee7272, #f29f9f, #f6cdcd, #fafafa);">

<div class="container py-4 custom-min-width">

    <div id="schedule-overview" class="container py-2 bg-white shadow rounded-4 p-4 py-4">
        <h2 class="mb-4 text-decoration-underline">Schedule Overview</h2>
        <div id='calendar'></div>
    </div>

    <!-- FullCalendar Scripts -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            allDaySlot: false,
            slotMinTime: "07:00:00",
            slotMaxTime: "18:00:00",

            eventDidMount: function(info) {
                const { courseCode, courseTitle, room, timeIn, timeOut } = info.event.extendedProps;

                const customHTML = `
                    <div style="white-space: normal; line-height: 1.2; font-size: 0.85rem;">
                        ${courseCode} - ${courseTitle}<br>
                        (${room} â€“ ${timeIn} to ${timeOut})
                    </div>
                `;

                const titleEl = info.el.querySelector('.fc-event-title');
                if (titleEl) {
                    titleEl.innerHTML = customHTML;
                }
            },

            events: [
                {% for sched in class_schedules %}
                {
                    title: "",  // We override this in eventDidMount
                    extendedProps: {
                        courseCode: "{{ sched.course_code }}",
                        courseTitle: "{{ sched.course_title }}",
                        section: "{{ sched.course_section }}",
                        room: "{{ sched.room_assignment }}",
                        timeIn: "{{ sched.time_in|time:'H:i' }}",
                        timeOut: "{{ sched.time_out|time:'H:i' }}"
                    },
                    daysOfWeek: [
                        {% for day in sched.day_list %}
                            {% if day|lower == 'monday' %}1{% elif day|lower == 'tuesday' %}2
                            {% elif day|lower == 'wednesday' %}3{% elif day|lower == 'thursday' %}4
                            {% elif day|lower == 'friday' %}5{% elif day|lower == 'saturday' %}6
                            {% elif day|lower == 'sunday' %}0{% endif %}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    startTime: "{{ sched.time_in|time:'H:i:s' }}",
                    endTime: "{{ sched.time_out|time:'H:i:s' }}",
                    startRecur: new Date().getFullYear() + "-01-01",
                    endRecur: new Date().getFullYear() + "-12-31",
                },
                {% endfor %}
            ]
        });

        calendar.render();
    });
    </script>



    <br>
    <div class="container py-2 bg-white shadow rounded-4 p-4 py-4">
        <h3 class="mb-4 text-decoration-underline">Current Courses</h3>
        <div class="table-responsive">
            <table class="table table-bordered align-middle text-center">
                <thead class="table-light">
                    <tr>
                        <th>Course Code</th>
                        <th>Course Name</th>
                        <th>Time in</th>
                        <th>Time Out</th>
                        <th>Room</th>
                        <th>Students</th>
                        <th>Grace Period (Minutes)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sched in class_schedules %}
                    <tr>
                        <td>{{ sched.course_code }}</td>
                        <td>{{ sched.course_title }}</td>
                        <td class="timein">{{ sched.time_in|time:"H:i" }}</td>
                        <td class="timeout">{{ sched.time_out|time:"H:i" }}</td>
                        <td class="room">{{ sched.room_assignment }}</td>
                        <td>{{ sched.student_count }}</td>
                        <td class="grace">{{ sched.grace_period }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary toggle-course-edit-btn"
                                    data-sched-id="{{ sched.id }}">
                                Edit
                            </button>

                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">No courses found for this instructor.</td>
                    </tr>
                    {% endfor %}
                </tbody>

            </table>    
        </div>
    </div>
</div>

<!-- JSON block to pass image URLs to JS -->
<script id="help-data" type="application/json">
{
    "steps": [
        "{% static 'image/schedule_inst.png' %}",
        "{% static 'image/attendance_records_inst.png' %}"
    ]
}
</script>

<!-- Modal -->
<div class="modal fade" id="helpGuideModal" tabindex="-1" aria-labelledby="helpGuideLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content shadow">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="helpGuideLabel">Help Guide</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body d-flex justify-content-center" id="helpSlide">
        <img id="helpImage" src="" alt="Help Guide Step" class="img-fluid rounded shadow" style="max-height: 75vh;" />
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button id="prevHelp" class="btn btn-secondary">Previous</button>
        <button id="nextHelp" class="btn btn-primary">Next</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="{% static 'js/instructor_schedule.js' %}"></script>

</body>
{% endblock %}
